{%- liquid
  comment
    set variables related to localization
  endcomment
  assign current_country = localization.country
  assign current_country_code = current_country.iso_code
  assign current_language_code = localization.language.iso_code
  assign current_currency_code = current_country.currency.iso_code
  assign primary_locale = ''
  for l in localization.available_languages
    if l.primary == true
      assign primary_locale = l.iso_code
    endif
  endfor
  assign default_country_code = section.settings.default_country_code
  assign default_locale_code = '/' | append: primary_locale
  if default_country_code != blank
    assign default_locale_code = default_locale_code | append: '-' | append: default_country_code
  endif
  assign default_locale_code = default_locale_code

  assign current_locale_code = '/' | append: current_language_code
  if current_country_code != blank
    assign current_locale_code = current_locale_code | append: '-' | append: current_country_code
  endif
  assign current_locale_code = current_locale_code

  comment
    set variables related to the request
  endcomment
  assign path = request.path
  if path contains request.locale.root_url
    assign path = path | split: request.locale.root_url | last
  endif
-%}
<script>
  window.shopify_locale_root = '{{ request.locale.root_url }}';
  window.shopify_locale_default = '{{ default_locale_code }}';
  window.shopify_locale_current = ' {{ current_locale_code }}';
  window.shopify_currency_code = '{{ current_currency_code }}';
  window.shopify_currency_default = '{{ section.settings.default_currency_code }}';
</script>
{% capture country_content %}
  <div class="flex flex-col gap-2 max-h-[600px] flex-wrap h-full">
    {% for block in section.blocks %}
      {% liquid
        assign country_code = block.settings.country_code | default: ""
        assign language_code = block.settings.language_code | default: ""
        assign display_name = block.settings.title | default: ""
        assign market_code = block.settings.market_code | default: ""
        assign iso_code = country_code | upcase
        assign country_flag = ""
        if country_code != blank
          assign active_country_list = localization.available_countries | where: 'iso_code', iso_code | default: ""
          assign country_object = active_country_list | first
          assign country_flag = country_object | image_url: width: 32 | image_tag
        endif
        capture country_url
          echo shop.url
          if language_code != blank
            assign locale_code = "/" | append: language_code
            if market_code != blank
              assign locale_code = locale_code | append: "-" | append: market_code
            elsif country_code != blank
              assign locale_code = locale_code | append: "-" | append: country_code
            endif
          endif
          assign locale_code = locale_code | downcase
          if locale_code != default_locale_code
            echo locale_code
          endif
          echo path
        endcapture
      %}
      <a href="{{ country_url }}" class="ra-link flex flex-row gap-2" data-country data-language-code="{{ language_code }}" data-country-code="{{ iso_code }}">{{ country_flag }} {{ display_name }}</a>
    {% endfor %}
  </div>
{% endcapture %}

{% capture country_checker_content %}
  <div class="max-w-[500px] w-full rounded p-2 flex items-start flex-col">
    <div class="w-full">
      {{ current_country | image_url: width: 64 | image_tag: class: 'block mx-auto mb-4' | default: "" }}
      <h5>Your location is set to {{ current_country.name }}</h5>
      <ul class="list-disc pl-4 mb-6">
        <li>Shop in {{ current_country.currency.name }} ({{ current_country.currency.symbol }})</li>
        <li>Get shipping options for {{ current_country.name }}</li>
      </ul>
      <button class="ra-button ra-button--primary ra-button--small w-full" data-modal-close>Continue</button>
      <span id="intl-modal" class="text-center underline block mx-auto cursor-pointer mt-4" data-modal-close>Change Country</span>
    </div>
  </div>
{% endcapture %}

<ra-countries data-default-locale="{{ default_locale_code }}" data-current-locale="{{ request.locale.root_url }}">
  {% form 'localization' %}
    <input type="hidden" name="country_code" value="{{ localization.country.iso_code }}">
    <input type="hidden" name="language_code" value="{{ localization.language.iso_code }}">
    {% render 'ra-modal',
      id: 'intl-modal',
      title: 'Modal Title',
      content: country_content,
      classes: 'gap-4 max-h-full'
    %}
  {% endform %}
  {% render 'ra-modal', id: 'country-checker-modal', content: country_checker_content, title: 'Modal Title' %}
</ra-countries>

{% schema %}
{
  "name": "Countries",
  "settings": [
    {
      "type": "text",
      "label": "Default Country Code",
      "id": "default_country_code",
      "info": "The ISO code of the Default country in ISO 3166-1 (alpha 2) format (e.g: US, CA, GB)"
    },
    {
      "type": "text",
      "label": "Default Currency Code",
      "id": "default_currency_code",
      "info": "The Currency Code of the Default country. (e.g. USD, CAD, EUR)"
    }
  ],
  "blocks": [
    {
      "type": "country",
      "name": "Country",
      "settings": [
        {
          "type": "text",
          "label": "Title",
          "id": "title"
        },
        {
          "type": "text",
          "label": "Country Code",
          "id": "country_code",
          "info": "The ISO code of the country in ISO 3166-1 (alpha 2) format (e.g: US, CA, GB)"
        },
        {
          "type": "text",
          "label": "Language Code",
          "id": "language_code",
          "info": "The ISO code of the locale in IETF language tag format (i.e. en for English, es for Spanish) "
        },
        {
          "type": "text",
          "label": "Market Code",
          "id": "market_code",
          "info": "The Suffix for the Market this Country belongs to"
        }
      ]
    }
  ]
}
{% endschema %}
